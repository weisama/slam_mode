# TCP 通信协议总结表

| 消息类型 | 方向 | 数据包格式 | 功能描述 | 数据格式 |
|---------|------|-----------|----------|----------|
| **通信测试指令** | 双向 | `AA 00 01 0A` | 连接状态测试 | 无数据载荷 |
| **保存地图指令** | 上位机→模块 | `AA 00 02 0A` | 保存地图 | 无数据载荷 |
| **读取参数指令** | 上位机→模块 | `AA 00 02 0A` | 保存地图 | 无数据载荷 |
| **参数配置** | 双向 | `AA 10 [参数ID] [值高字节] [值低字节] 0A` | 修改系统参数 | 二进制参数值 |
| **TF变换数据** | 模块→上位机 | `AA 01 [JSON数据] 0A` | 发布坐标变换数据 | JSON格式，包含位置和四元数 |
| **激光雷达数据** | 模块→上位机 | `AA 02 [JSON数据] 0A` | 发布激光扫描数据 | JSON格式，包含角度和距离数组 |
| **地图数据** | 模块→上位机 | `AA 03 [JSON数据] 0A` | 发布占用栅格地图 | JSON格式，RLE压缩地图数据 |

## 参数ID定义表

| 参数ID | 参数名称 | 值范围 | 说明 |
|--------|----------|--------|------|
| 0x00 | 雷达型号 | 0-1 | 0=N10, 1=N10_P |
| 0x01~0x06 | 雷达安装位置 |  | 雷达安装位置相对于机器人中心的位置，即tf树中：base_link->laser_link，坐标系遵循FLU（x为前，Y为左，Z为上） |
| 0x01 | X坐标 | 0-65535 | 雷达位置X坐标值，单位厘米 |
| 0x02 | Y坐标 | 0-65535 | 雷达位置Y坐标值，单位厘米 |
| 0x03 | Z坐标 | 0-65535 | 雷达位置Z坐标值，单位厘米 |
| 0x04 | Roll角度 | 0-360 | 雷达滚转角，单位度 |
| 0x05 | Pitch角度 | 0-360 | 雷达俯仰角，单位度 |
| 0x06 | Yaw角度 | 0-360 | 雷达偏航角，单位度 |
| 0x10 | 建图or定位模式 | 0-1 | 0=mapping，1=localization，保存地图后可以设置为定位模式，重启模块后则会调用保存的地图进行定位 |

## JSON数据结构表

| 数据类型 | JSON字段 | 数据类型 | 说明 |
|----------|----------|----------|------|
| **TF数据** | frame_id, child_frame_id | string | 坐标系名称 |
|  | x, y, z | float | 位置坐标 |
|  | qx, qy, qz, qw | float | 四元数姿态 |
| **激光数据** | angle_min, angle_max | float | 扫描角度范围 |
|  | angle_increment | float | 角度增量 |
|  | range_count | int | 数据点数 |
|  | ranges | float[] | 距离数组 |
| **地图数据** | width, height | int | 地图尺寸 |
|  | resolution | float | 地图分辨率 |
|  | origin_x, origin_y | float | 地图原点 |
|  | rle | int[][] | RLE压缩数据 [值,计数] |

## 通信配置表

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| TCP IP地址 | 0.0.0.0 | 监听所有网络接口 |
| TCP端口 | 6666 | 可通过参数配置 |
| 连接管理 | 非阻塞 | 支持多上位机 |
| 数据统计 | 1秒间隔 | 监控收发字节数 |

## 特殊说明表

| 项目 | 说明 |
|------|------|
| 字节序 | 大端序 (Big-endian) |
| 编码格式 | UTF-8 |
| 地图压缩 | RLE运行长度编码 |
| 错误处理 | 自动重连，异常断开处理 |


```json
{
  "protocol_schemas": {
    "tf_data": {
      "description": "坐标变换数据",
      "fields": {
        "topic": {"type": "string", "value": "tf", "description": "主题标识"},
        "frame_id": {"type": "string", "description": "父坐标系名称"},
        "child_frame_id": {"type": "string", "description": "子坐标系名称"},
        "x": {"type": "float", "description": "X轴位置坐标"},
        "y": {"type": "float", "description": "Y轴位置坐标"},
        "z": {"type": "float", "description": "Z轴位置坐标"},
        "qx": {"type": "float", "description": "四元数X分量"},
        "qy": {"type": "float", "description": "四元数Y分量"},
        "qz": {"type": "float", "description": "四元数Z分量"},
        "qw": {"type": "float", "description": "四元数W分量"}
      },
      "example": {
        "topic": "tf",
        "frame_id": "odom",
        "child_frame_id": "base_link",
        "x": 1.5,
        "y": 2.3,
        "z": 0.1,
        "qx": 0.0,
        "qy": 0.0,
        "qz": 0.382,
        "qw": 0.924
      }
    },
    
    "scan_data": {
      "description": "激光雷达扫描数据",
      "fields": {
        "topic": {"type": "string", "value": "scan", "description": "主题标识"},
        "angle_min": {"type": "float", "description": "起始角度(弧度)"},
        "angle_max": {"type": "float", "description": "结束角度(弧度)"},
        "angle_increment": {"type": "float", "description": "角度增量(弧度)"},
        "range_count": {"type": "integer", "description": "数据点数量"},
        "ranges": {"type": "array", "items": "float", "description": "距离测量值数组"}
      },
      "example": {
        "topic": "scan",
        "angle_min": -3.14,
        "angle_max": 3.14,
        "angle_increment": 0.017,
        "range_count": 360,
        "ranges": [1.5, 1.52, 1.48, 1.51, 2.3, 2.29, 1.8, 1.79, 1.81, 1.82]
      }
    },
    
    "map_data": {
      "description": "占用栅格地图数据",
      "fields": {
        "topic": {"type": "string", "value": "map", "description": "主题标识"},
        "width": {"type": "integer", "description": "地图宽度(像素)"},
        "height": {"type": "integer", "description": "地图高度(像素)"},
        "resolution": {"type": "float", "description": "地图分辨率(米/像素)"},
        "origin_x": {"type": "float", "description": "地图原点X坐标"},
        "origin_y": {"type": "float", "description": "地图原点Y坐标"},
        "rle": {
          "type": "array", 
          "items": {"type": "array", "items": "integer", "size": 2},
          "description": "RLE压缩数据 [单元格值, 连续计数]"
        }
      },
      "compression_note": {
        "rle_encoding": "运行长度编码压缩",
        "cell_values": {
          "-1": "未知区域",
          "0": "空闲区域", 
          "100": "占用区域"
        },
        "max_run_length": 255
      },
      "example": {
        "topic": "map",
        "width": 384,
        "height": 384,
        "resolution": 0.05,
        "origin_x": -10.0,
        "origin_y": -10.0,
        "rle": [
          [-1, 50],
          [0, 100],
          [100, 5],
          [0, 80],
          [-1, 30]
        ]
      }
    }
  },
  
  "message_types": {
    "test_command": {
      "hex_code": "0x00",
      "direction": "bidirectional",
      "format": "AA 00 01 0A",
      "description": "通信测试命令"
    },
    "parameter_command": {
      "hex_code": "0x10", 
      "direction": "client_to_server",
      "format": "AA 10 [param_id] [val_high] [val_low] 0A",
      "description": "参数配置命令"
    },
    "tf_message": {
      "hex_code": "0x01",
      "direction": "server_to_client", 
      "format": "AA 01 [json_data] 0A",
      "description": "TF变换数据"
    },
    "scan_message": {
      "hex_code": "0x02",
      "direction": "server_to_client",
      "format": "AA 02 [json_data] 0A", 
      "description": "激光雷达数据"
    },
    "map_message": {
      "hex_code": "0x03",
      "direction": "server_to_client",
      "format": "AA 03 [json_data] 0A",
      "description": "地图数据"
    }
  },
  
  "parameter_ids": {
    "0x00": {"name": "lidar_model", "description": "雷达型号", "values": {"0": "N10", "other": "N10_P"}},
    "0x01": {"name": "x_coordinate", "description": "X坐标", "range": "0-65535"},
    "0x02": {"name": "y_coordinate", "description": "Y坐标", "range": "0-65535"},
    "0x03": {"name": "z_coordinate", "description": "Z坐标", "range": "0-65535"},
    "0x04": {"name": "roll_angle", "description": "滚转角", "range": "0-65535"},
    "0x05": {"name": "pitch_angle", "description": "俯仰角", "range": "0-65535"},
    "0x06": {"name": "yaw_angle", "description": "偏航角", "range": "0-65535"}
  }
}
```
